module Ergvein.Filters.Btc.TestVectors where

import Control.Monad.Reader
import Data.ByteString (ByteString)
import Data.Text (Text)
import Data.Map.Strict (Map)
import Ergvein.Filters.Btc.Index
import Ergvein.Filters.Btc.TestHelpers
import Network.Haskoin.Block
import Network.Haskoin.Transaction

import qualified Data.Map.Strict as M

import Debug.Trace

data TVecRow = TVecRow {
  tvecHeight     :: !Integer
, tvecBlockHash  :: !BlockHash
, tvecBlock      :: !Block
, tvecScripts    :: ![ByteString]
, tvecPrevHash   :: !FilterHash
, tvecFilter     :: !Text
, tvecFilterHash :: !FilterHash
, tvecNote       :: !Text
}

-- Got from https://github.com/jimpo/bitcoin/blob/c7efb652f3543b001b4dd22186a354605b14f47e/src/test/data/blockfilters.json
testVector :: [TVecRow]
testVector = [
      TVecRow {
      tvecHeight     = 0
    , tvecBlockHash  = loadBlockHash "000000000933ea01ad0ee984209779baaec3ced90fa3f408719526f8d77f4943"
    , tvecBlock      = loadBlock "0100000000000000000000000000000000000000000000000000000000000000000000003ba3edfd7a7b12b27ac72c3e67768f617fc81bc3888a51323a9fb8aa4b1e5e4adae5494dffff001d1aa4ae180101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff4d04ffff001d0104455468652054696d65732030332f4a616e2f32303039204368616e63656c6c6f72206f6e206272696e6b206f66207365636f6e64206261696c6f757420666f722062616e6b73ffffffff0100f2052a01000000434104678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5fac00000000"
    , tvecScripts    = []
    , tvecPrevHash   = filterHashFromText "0000000000000000000000000000000000000000000000000000000000000000"
    , tvecFilter     = "019dfca8"
    , tvecFilterHash = filterHashFromText "21584579b7eb08997773e5aeff3a7f932700042d0ed2a6129012b7d7ae81b750"
    , tvecNote       = "Genesis block"
    }
    , TVecRow {
      tvecHeight     = 2
    , tvecBlockHash  = loadBlockHash "000000006c02c8ea6e4ff69651f7fcde348fb9d557a06e6957b65552002a7820"
    , tvecBlock      = loadBlock "0100000006128e87be8b1b4dea47a7247d5528d2702c96826c7a648497e773b800000000e241352e3bec0a95a6217e10c3abb54adfa05abb12c126695595580fb92e222032e7494dffff001d00d235340101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0e0432e7494d010e062f503253482fffffffff0100f2052a010000002321038a7f6ef1c8ca0c588aa53fa860128077c9e6c11e6830f4d7ee4e763a56b7718fac00000000"
    , tvecScripts    = []
    , tvecPrevHash   = filterHashFromText "d7bdac13a59d745b1add0d2ce852f1a0442e8945fc1bf3848d3cbffd88c24fe1"
    , tvecFilter     = "0174a170"
    , tvecFilterHash = filterHashFromText "186afd11ef2b5e7e3504f2e8cbf8df28a1fd251fe53d60dff8b1467d1b386cf0"
    , tvecNote       = ""
    }
    , TVecRow {
      tvecHeight     = 3
    , tvecBlockHash  = loadBlockHash "000000008b896e272758da5297bcd98fdc6d97c9b765ecec401e286dc1fdbe10"
    , tvecBlock      = loadBlock "0100000020782a005255b657696ea057d5b98f34defcf75196f64f6eeac8026c0000000041ba5afc532aae03151b8aa87b65e1594f97504a768e010c98c0add79216247186e7494dffff001d058dc2b60101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0e0486e7494d0151062f503253482fffffffff0100f2052a01000000232103f6d9ff4c12959445ca5549c811683bf9c88e637b222dd2e0311154c4c85cf423ac00000000"
    , tvecScripts    = []
    , tvecPrevHash   = filterHashFromText "186afd11ef2b5e7e3504f2e8cbf8df28a1fd251fe53d60dff8b1467d1b386cf0"
    , tvecFilter     = "016cf7a0"
    , tvecFilterHash = filterHashFromText "8d63aadf5ab7257cb6d2316a57b16f517bff1c6388f124ec4c04af1212729d2a"
    , tvecNote       = ""
    }
    , TVecRow {
      tvecHeight     = 15007
    , tvecBlockHash  = loadBlockHash "0000000038c44c703bae0f98cdd6bf30922326340a5996cc692aaae8bacf47ad"
    , tvecBlock      = loadBlock "0100000002394092aa378fe35d7e9ac79c869b975c4de4374cd75eb5484b0e1e00000000eb9b8670abd44ad6c55cee18e3020fb0c6519e7004b01a16e9164867531b67afc33bc94fffff001d123f10050101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0e04c33bc94f0115062f503253482fffffffff0100f2052a01000000232103f268e9ae07e0f8cb2f6e901d87c510d650b97230c0365b021df8f467363cafb1ac00000000"
    , tvecScripts    = []
    , tvecPrevHash   = filterHashFromText "18b5c2b0146d2d09d24fb00ff5b52bd0742f36c9e65527abdb9de30c027a4748"
    , tvecFilter     = "013c3710"
    , tvecFilterHash = filterHashFromText "07384b01311867949e0c046607c66b7a766d338474bb67f66c8ae9dbd454b20e"
    , tvecNote       = "Tx has non-standard OP_RETURN output followed by opcodes"
    }
    , TVecRow {
      tvecHeight     = 49291
    , tvecBlockHash  = loadBlockHash "0000000018b07dca1b28b4b5a119f6d6e71698ce1ed96f143f54179ce177a19c"
    , tvecBlock      = loadBlock "02000000abfaf47274223ca2fea22797e44498240e482cb4c2f2baea088962f800000000604b5b52c32305b15d7542071d8b04e750a547500005d4010727694b6e72a776e55d0d51ffff001d211806480201000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0d038bc0000102062f503253482fffffffff01a078072a01000000232102971dd6034ed0cf52450b608d196c07d6345184fcb14deb277a6b82d526a6163dac0000000001000000081cefd96060ecb1c4fbe675ad8a4f8bdc61d634c52b3a1c4116dee23749fe80ff000000009300493046022100866859c21f306538152e83f115bcfbf59ab4bb34887a88c03483a5dff9895f96022100a6dfd83caa609bf0516debc2bf65c3df91813a4842650a1858b3f61cfa8af249014730440220296d4b818bb037d0f83f9f7111665f49532dfdcbec1e6b784526e9ac4046eaa602204acf3a5cb2695e8404d80bf49ab04828bcbe6fc31d25a2844ced7a8d24afbdff01ffffffff1cefd96060ecb1c4fbe675ad8a4f8bdc61d634c52b3a1c4116dee23749fe80ff020000009400483045022100e87899175991aa008176cb553c6f2badbb5b741f328c9845fcab89f8b18cae2302200acce689896dc82933015e7230e5230d5cff8a1ffe82d334d60162ac2c5b0c9601493046022100994ad29d1e7b03e41731a4316e5f4992f0d9b6e2efc40a1ccd2c949b461175c502210099b69fdc2db00fbba214f16e286f6a49e2d8a0d5ffc6409d87796add475478d601ffffffff1e4a6d2d280ea06680d6cf8788ac90344a9c67cca9b06005bbd6d3f6945c8272010000009500493046022100a27400ba52fd842ce07398a1de102f710a10c5599545e6c95798934352c2e4df022100f6383b0b14c9f64b6718139f55b6b9494374755b86bae7d63f5d3e583b57255a01493046022100fdf543292f34e1eeb1703b264965339ec4a450ec47585009c606b3edbc5b617b022100a5fbb1c8de8aaaa582988cdb23622838e38de90bebcaab3928d949aa502a65d401ffffffff1e4a6d2d280ea06680d6cf8788ac90344a9c67cca9b06005bbd6d3f6945c8272020000009400493046022100ac626ac3051f875145b4fe4cfe089ea895aac73f65ab837b1ac30f5d875874fa022100bc03e79fa4b7eb707fb735b95ff6613ca33adeaf3a0607cdcead4cfd3b51729801483045022100b720b04a5c5e2f61b7df0fcf334ab6fea167b7aaede5695d3f7c6973496adbf1022043328c4cc1cdc3e5db7bb895ccc37133e960b2fd3ece98350f774596badb387201ffffffff23a8733e349c97d6cd90f520fdd084ba15ce0a395aad03cd51370602bb9e5db3010000004a00483045022100e8556b72c5e9c0da7371913a45861a61c5df434dfd962de7b23848e1a28c86ca02205d41ceda00136267281be0974be132ac4cda1459fe2090ce455619d8b91045e901ffffffff6856d609b881e875a5ee141c235e2a82f6b039f2b9babe82333677a5570285a6000000006a473044022040a1c631554b8b210fbdf2a73f191b2851afb51d5171fb53502a3a040a38d2c0022040d11cf6e7b41fe1b66c3d08f6ada1aee07a047cb77f242b8ecc63812c832c9a012102bcfad931b502761e452962a5976c79158a0f6d307ad31b739611dac6a297c256ffffffff6856d609b881e875a5ee141c235e2a82f6b039f2b9babe82333677a5570285a601000000930048304502205b109df098f7e932fbf71a45869c3f80323974a826ee2770789eae178a21bfc8022100c0e75615e53ee4b6e32b9bb5faa36ac539e9c05fa2ae6b6de5d09c08455c8b9601483045022009fb7d27375c47bea23b24818634df6a54ecf72d52e0c1268fb2a2c84f1885de022100e0ed4f15d62e7f537da0d0f1863498f9c7c0c0a4e00e4679588c8d1a9eb20bb801ffffffffa563c3722b7b39481836d5edfc1461f97335d5d1e9a23ade13680d0e2c1c371f030000006c493046022100ecc38ae2b1565643dc3c0dad5e961a5f0ea09cab28d024f92fa05c922924157e022100ebc166edf6fbe4004c72bfe8cf40130263f98ddff728c8e67b113dbd621906a601210211a4ed241174708c07206601b44a4c1c29e5ad8b1f731c50ca7e1d4b2a06dc1fffffffff02d0223a00000000001976a91445db0b779c0b9fa207f12a8218c94fc77aff504588ac80f0fa02000000000000000000"
    , tvecScripts    = fmap loadScript ["5221033423007d8f263819a2e42becaaf5b06f34cb09919e06304349d950668209eaed21021d69e2b68c3960903b702af7829fadcd80bd89b158150c85c4a75b2c8cb9c39452ae","52210279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179821021d69e2b68c3960903b702af7829fadcd80bd89b158150c85c4a75b2c8cb9c39452ae","522102a7ae1e0971fc1689bd66d2a7296da3a1662fd21a53c9e38979e0f090a375c12d21022adb62335f41eb4e27056ac37d462cda5ad783fa8e0e526ed79c752475db285d52ae","52210279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f8179821022adb62335f41eb4e27056ac37d462cda5ad783fa8e0e526ed79c752475db285d52ae","512103b9d1d0e2b4355ec3cdef7c11a5c0beff9e8b8d8372ab4b4e0aaf30e80173001951ae","76a9149144761ebaccd5b4bbdc2a35453585b5637b2f8588ac","522103f1848b40621c5d48471d9784c8174ca060555891ace6d2b03c58eece946b1a9121020ee5d32b54d429c152fdc7b1db84f2074b0564d35400d89d11870f9273ec140c52ae","76a914f4fa1cc7de742d135ea82c17adf0bb9cf5f4fb8388ac"]
    , tvecPrevHash   = filterHashFromText "ed47705334f4643892ca46396eb3f4196a5e30880589e4009ef38eae895d4a13"
    , tvecFilter     = "0afbc2920af1b027f31f87b592276eb4c32094bb4d3697021b4c6380"
    , tvecFilterHash = filterHashFromText "b6d98692cec5145f67585f3434ec3c2b3030182e1cb3ec58b855c5c164dfaaa3"
    , tvecNote       = "Tx pays to empty output script"
    }
  ]

testVecPrevIndex :: TVecRow -> Map OutPoint ByteString
testVecPrevIndex TVecRow{..} = M.fromList $ outs `zip` tvecScripts
  where
    outs = traceShowId $ fmap prevOutput $ concat $ fmap txIn $ drop 1 $ blockTxns tvecBlock

withPrevScripts :: TVecRow -> (ReaderT (Map OutPoint ByteString) m a) -> m a
withPrevScripts = flip runReaderT . testVecPrevIndex
